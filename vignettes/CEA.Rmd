---
title: "CEA"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{CEA}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 10,
  fig.height = 10,
  out.width = "100%"
)
```

```{r setup}
library(CEA)
library(ggplot2)
library(ggsci)
library(ggh4x)
library(ggpubr)
library(tidyverse)
library(lme4)
library(lmerTest)
library(ComplexHeatmap)
library(RColorBrewer)
```


# Introduction 

CEA is an R package for contrastive eigen-analysis including contrastive PCA (cPCA) and its sparse version (scPCA), contrastive cross-covariance analysis (3CA) and its sparse version (s3CA).


In this vignette, we will use CEA package to reproduce the analysis in the original paper, including

1. Simulation for $\eta$ tuning algorithm, generating Fig 2, Table 1, Fig S1.

2. Simulation for cPCA, generating Fig 3a, Fig S2.

3. Simulation for scPCA, generating Fig 3b.

4. Simulation for robustness of $\eta$ tuning algorithm. Fig S3, Fig S4

5. Simulation for 3CA, generating Fig 4.

6. Simulation for s3CA, generating Fig 5 and Fig S5.

7. Real data application of scPCA generating Fig 6 and Fig 7, Fig S6 and Fig S7.

8. Real data application of s3CA generating Fig 8 and Table 2, Fig S8.

# Simulation

## 1. Simulation for validation of $\eta$ tuning algorithm.

```{r simulation eta_tuning algorithm, eval=FALSE}
beta_12_candidates <- c(10, 11, 12)
n_candidates <- c(100, 200, 300)
p_candidates <- c(10)
eta_range <- seq(0.1, 5, 0.05)
results <- setNames(data.frame(matrix(ncol = 7, nrow = 0)), 
                    c("eta", "eta_true", "nuisance_ARI", "silhouette",
                      "beta12", "SampleGroupSize", "FeatureGroupSize"))

eta_opt_res <- setNames(data.frame(matrix(ncol = 4, nrow = 0)), 
                    c("eta_opt", "beta12",  "SampleGroupSize", "FeatureGroupSize"))
nuisance_ARI_repe_list <- list()
silhouette_repe_list <- list()
eta_opt_repe_list <- list()
for (beta_12 in beta_12_candidates) {
    for (n in n_candidates) {
      for(p in p_candidates){
         res <- sim_eta_tuning(gnt = n, gnc = n, p = p, q = p, t = p,
                               sigma_1t = 1, sigma_2t = 1, sigma_3t = 1,
                               sigma_1c = 1, sigma_2c = 1, sigma_3c = 1, 
                               Sigma_t = NULL, Sigma_c = NULL,
                               beta_11 = 7, beta_12 = beta_12, beta_21 = 3, beta_22 = 6,
                               gamma_11 = -3, gamma_12 = 3, gamma_21 = -3, gamma_22 = 3,
                               eta_range = eta_range, repetition = 50)
         res_df <- res$res_df
         res_df$beta_12 <- beta_12
         res_df$SampleGroupSize <- n
         res_df$FeatureGroupSize <- p
         results <- rbind(results, res_df)
         
         eta_opt_res_df <- data.frame(eta_opt=res$eta_opt,
                                      beta_12=beta_12,
                                      SampleGroupSize=n,
                                      FeatureGroupSize=p)
         eta_opt_res <- rbind(eta_opt_res, eta_opt_res_df)
         
         nuisance_ARI_repe_list <- append(nuisance_ARI_repe_list, list(res$nuisance_ARI_repe))
         silhouette_repe_list <- append(silhouette_repe_list, list(res$silhouette_repe))
         eta_opt_repe_list <- append(eta_opt_repe_list, list(res$eta_opt_repe))
         names(nuisance_ARI_repe_list)[length(nuisance_ARI_repe_list)] <- names(silhouette_repe_list)[length(silhouette_repe_list)]  <- names(eta_opt_repe_list)[length(eta_opt_repe_list)] <- paste("beta_12=", beta_12, ",n=", n, sep = "")
         
      }
    }
}
eta_opt_res$beta_12 <- paste("beta[12]==", eta_opt_res$beta_12, sep = "")
eta_opt_res$SampleGroupSize <- paste("n==", eta_opt_res$SampleGroupSize, sep = "")
# save(results, eta_opt_res,nuisance_ARI_repe_list, silhouette_repe_list, eta_opt_repe_list, file = "../inst/SavedData/sim_etaTuning.RData")
## change repetition to 1
# save(results, eta_opt_res,nuisance_ARI_repe_list, silhouette_repe_list, eta_opt_repe_list, file = "../inst/SavedData/sim_etaTuning_1repe.RData")
```

#### Table 1
```{r simulation eta_tuning algorithm visualization (variability), eval=TRUE}
load("../inst/SavedData/sim_etaTuning.RData") # for averaged results

# 1. Evaluate variability of eta_opt, ARI and silhouette (Table 1)
variability <- setNames(data.frame(matrix(ncol = 9, nrow = 6),row.names = c("Interaction", "n","Min(eta)", "Max(eta)", "SD(ARI)", "SD(Sil)")), names(eta_opt_repe_list))

variability["Interaction",] <- sapply(names(eta_opt_repe_list),function(x){strsplit(x,",")[[1]][1]})
variability["n",] <- sapply(names(eta_opt_repe_list),function(x){strsplit(x,",")[[1]][2]})


# min and max optimal eta across repetitions
variability["Min(eta)",] <- unlist(lapply(eta_opt_repe_list, min))
variability["Max(eta)",] <- unlist(lapply(eta_opt_repe_list, max))

# average SE across candidate eta of the metric
variability["SD(ARI)",] <- round(unlist(lapply(nuisance_ARI_repe_list,
                                              function(x){mean(apply(x,2,sd))})),3)
variability["SD(Sil)",] <- round(unlist(lapply(silhouette_repe_list,
                                              function(x){mean(apply(x,2,sd))})),3)

knitr::kable(variability, caption = "Variability of eta tuning simulation", col.names = c())
```

#### Fig 2

```{r simulation eta_tuning algorithm visualization (scatter plot), eval=TRUE}
# 2. Scatter plot of metrics versus candidate eta values (Fig 2)
plot_df <- pivot_longer(results[results$eta %in% seq(0.1,5,0.25),], 3:4, names_to = "Metric", values_to = "Values")
plot_df$Interaction <- plot_df$beta_12
plot_df$Interaction[plot_df$beta_12 == 10] <- "Interaction==0"
plot_df$Interaction[plot_df$beta_12 == 11] <- "Interaction==1"
plot_df$Interaction[plot_df$beta_12 == 12] <- "Interaction==2"
plot_df$beta_12 <- paste("beta[12]==", plot_df$beta_12, sep = "")
plot_df$SampleGroupSize <- paste("n==", plot_df$SampleGroupSize, sep = "")
plot_df$eta_true <- factor(plot_df$eta_true, levels = c("BadEta","GoodEta"), labels = c( "Outside range","In range"))
plot_df$Metric <- factor(plot_df$Metric, levels = c("nuisance_ARI","silhouette"), labels = c("ARI(nuisance)", "Silhouette score"))
eta_opt_res$Interaction <- rep(c("Interaction==0","Interaction==1","Interaction==2"), each=3)
p_eta <- ggplot(data = plot_df)+
    geom_point(aes(x = eta, y = Values, shape = Metric, color = eta_true), size = 2)+
    geom_vline(data = eta_opt_res, aes(xintercept = eta_opt), linetype = "dashed")+
    facet_grid(cols = vars(Interaction), rows =vars(SampleGroupSize), labeller = label_parsed)+
    theme_bw()+
    scale_shape_manual(values=c(5,16))+
    theme(
      panel.grid = element_blank(),
      strip.background = element_rect(fill = "lightblue", color = "black"),
      strip.text = element_text(color = "black", face = "bold", size = 14),
      text = element_text(size = 14),  # Adjust text size
      axis.title = element_text(size = 16),  # Adjust axis title size
      axis.text = element_text(size = 12),   # Adjust axis text size
      legend.position = "bottom")+
    labs(x = expression(eta), y = "", color = "", shape = "")+
    scale_color_aaas()

print(p_eta)
# ggsave("../inst/SavedFigures/sim_etaTuning.pdf", plot = p_eta, width = 9, height = 7, units = "in")
```

#### Fig S1

```{r simulation eta_tuning algorithm visualization (scatter plot singe dataset), eval=TRUE}
# 3. Scatter plot of metrics versus candidate eta values for only 1 dataset (Fig S1)
load("../inst/SavedData/sim_etaTuning_1repe.RData")
plot_df <- pivot_longer(results[results$eta %in% seq(0.1,5,0.25),], 3:4, names_to = "Metric", values_to = "Values")
plot_df$Interaction <- plot_df$beta_12
plot_df$Interaction[plot_df$beta_12 == 10] <- "Interaction==0"
plot_df$Interaction[plot_df$beta_12 == 11] <- "Interaction==1"
plot_df$Interaction[plot_df$beta_12 == 12] <- "Interaction==2"
plot_df$beta_12 <- paste("beta[12]==", plot_df$beta_12, sep = "")
plot_df$SampleGroupSize <- paste("n==", plot_df$SampleGroupSize, sep = "")
plot_df$eta_true <- factor(plot_df$eta_true, levels = c("BadEta","GoodEta"), labels = c( "Outside range","In range"))
plot_df$Metric <- factor(plot_df$Metric, levels = c("nuisance_ARI","silhouette"), labels = c("ARI(nuisance)", "Silhouette score"))
eta_opt_res$Interaction <- rep(c("Interaction==0","Interaction==1","Interaction==2"), each=3)
p_eta <- ggplot(data = plot_df)+
    geom_point(aes(x = eta, y = Values, shape = Metric, color = eta_true), size = 2)+
    geom_vline(data = eta_opt_res, aes(xintercept = eta_opt), linetype = "dashed")+
    facet_grid(cols = vars(Interaction), rows =vars(SampleGroupSize), labeller = label_parsed)+
    theme_bw()+
    scale_shape_manual(values=c(5,16))+
    theme(
      panel.grid = element_blank(),
      strip.background = element_rect(fill = "lightblue", color = "black"),
      strip.text = element_text(color = "black", face = "bold", size = 14),
      text = element_text(size = 14),  # Adjust text size
      axis.title = element_text(size = 16),  # Adjust axis title size
      axis.text = element_text(size = 12),   # Adjust axis text size
      legend.position = "bottom")+
    labs(x = expression(eta), y = "", color = "", shape = "")+
    scale_color_aaas()

print(p_eta)
# ggsave("../inst/SavedFigures/sim_etaTuning_1repe.pdf", plot = p_eta, width = 9, height = 7, units = "in")
```


## 2. Simulation for cPCA

#### Fig S2: set save_plot = TRUE

```{r simulation for cPCA, eval = FALSE}
beta_12_candidates <- c(11, 12)
n_candidates <- c(100,200,300)
p_candidates <- c(10)
eta_range <- seq(0.1, 5, 0.05)
results <- setNames(data.frame(matrix(ncol = 8, nrow = 0)), 
                    c("ARI_ctst_discovery", "ARI_ctst_nuisance",
                      "ARI_trt_discovery", "ARI_trt_nuisance",
                       "eta",  "beta12", "SampleGroupSize", "FeatureGroupSize"))

for (beta_12 in beta_12_candidates) {
    for (n in n_candidates) {
      for(p in p_candidates){
         res <- sim_cPCA (gnt = n, gnc = n, p = p, q = p, t = p,
                          sigma_1t = 1, sigma_2t = 1, sigma_3t = 1, 
                          sigma_1c = 1, sigma_2c = 1, sigma_3c = 1, 
                          Sigma_t = NULL, Sigma_c = NULL,
                          beta_11 = 7, beta_12 = beta_12, beta_21 = 3, beta_22 = 6,
                          gamma_11 = -3, gamma_12 = 3, gamma_21 = -3, gamma_22 = 3,
                          eta = eta_range, repetition = 50, 
                          save_plot = TRUE)
         res$beta_12 <- beta_12
         res$SampleGroupSize <- n
         res$FeatureGroupSize <- p
         results <- rbind(results, res)
      }
    }
}
# save(results, file = "../inst/SavedData/sim_cPCA.RData")

```

#### Fig 3a 

```{r simulation for cPCA visualization}
load("../inst/SavedData/sim_cPCA.RData")
plot_results <- pivot_longer(results, 1:4, names_to = "Type", values_to = "ARI")
plot_results$Analysis <- sapply(plot_results$Type, function(x){strsplit(x,"_")[[1]][2]})
plot_results$Factor <- sapply(plot_results$Type, function(x){strsplit(x,"_")[[1]][3]})
plot_results$Analysis <- ifelse(plot_results$Analysis=="ctst","Contrastive","Treatment")
plot_results$Factor <- ifelse(plot_results$Factor=="discovery","Interesting","Nuisance")
plot_results$eta <- paste("eta==", plot_results$eta, sep = "")
plot_results$beta_12_num <- plot_results$beta_12
plot_results$beta_12 <- paste("beta[12]==", plot_results$beta_12, sep = "")
plot_results$SampleGroupSize <- paste("n==", plot_results$SampleGroupSize, sep = "")
print(knitr::kable(plot_results %>% group_by(beta_12, Factor, Analysis) %>%  summarise(Average_ARI = mean(ARI), SE_ARI = sd(ARI))), format = "markdown")
plot_results <- plot_results %>% group_by(beta_12, Factor, SampleGroupSize, Analysis) %>%  summarise(Average_ARI = mean(ARI), SE_ARI = sd(ARI))
plot_results$Interaction <- ifelse(plot_results$beta_12=="beta[12]==11", "Interaction==1","Interaction==2")


p_cPCA <- ggplot(plot_results)+
  geom_bar(aes(x = Factor, fill = Analysis, y = Average_ARI+0.5), stat="identity", position ="dodge")+
  facet_nested( ~ Interaction + SampleGroupSize, labeller = label_parsed)+
  labs(x = "", y="Average ARI")+
  scale_y_continuous(breaks = c(0.5,1,1.5), limits = c(0,1.5), labels=c("0","0.5","1"))+
  theme_bw()+
  theme(
    panel.grid = element_blank(),
    strip.background = element_rect(fill = "lightblue", color = "black"),
    strip.text = element_text(color = "black", face = "bold", size = 14),
    text = element_text(size = 14),  # Adjust text size
    axis.title = element_text(size = 16),  # Adjust axis title size
    axis.text = element_text(size = 12),   # Adjust axis text size
    # axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom"
  )+
  scale_color_aaas()
print(p_cPCA)

# ggsave("../inst/SavedFigures/sim_cPCA.pdf", plot = p_cPCA, width = 12, height = 3.5, units = "in")

```


## 3. Simulation for scPCA

```{r simulation for scPCA, eval = FALSE}
set.seed(123)
beta_12_candidates <- c(11, 12)
n_candidates <- c(100)
p_candidates <- c(630, 830, 1230)
eta_range <- seq(0.1, 5, 0.1)
results <- setNames(data.frame(matrix(ncol = 8, nrow = 0)), 
                    c("ARI_ctst_discovery", "ARI_ctst_nuisance",
                      "ARI_trt_discovery", "ARI_trt_nuisance",
                      "eta", "beta12", "SampleGroupSize", "Dimension"))

for (beta_12 in beta_12_candidates) {
    for (n in n_candidates) {
      for(p in p_candidates){
        cat("finish one \n")
         res <- sim_scPCA(gnt = n, gnc = n, p = p, q = 10, t = 10,
                          sigma_1t = 1, sigma_2t = 1, sigma_3t = 1, 
                          sigma_1c = 1, sigma_2c = 1, sigma_3c = 1, 
                          Sigma_t = NULL, Sigma_c = NULL,
                          beta_11 = 7, beta_12 = beta_12, beta_21 = 3, beta_22 = 6,
                          gamma_11 = -3, gamma_12 = 3, gamma_21 = -3, gamma_22 = 3,
                          eta = eta_range, repetition = 50, 
                          save_plot = FALSE)
         res$beta_12 <- beta_12
         res$SampleGroupSize <- n
         res$Dimension <- p + 20
         results <- rbind(results, res)
    }
  }
}

# save(results, file = "../inst/SavedData/sim_scPCA.RData")

```

#### Fig 3b

```{r simulation for scPCA visualization}
load("../inst/SavedData/sim_scPCA.RData")
plot_results <- pivot_longer(results, 1:4, names_to = "Type", values_to = "ARI")
plot_results$Analysis <- sapply(plot_results$Type, function(x){strsplit(x,"_")[[1]][2]})
plot_results$Factor <- sapply(plot_results$Type, function(x){strsplit(x,"_")[[1]][3]})
plot_results$Analysis <- ifelse(plot_results$Analysis=="ctst","Contrastive","Treatment")
plot_results$Factor <- ifelse(plot_results$Factor=="discovery","Interesting","Nuisance")
plot_results$eta <- paste("eta==", plot_results$eta, sep = "")
plot_results$beta_12 <- paste("beta[12]==", plot_results$beta_12, sep = "")
plot_results$SampleGroupSize <- paste("n=", plot_results$SampleGroupSize, sep = "")
plot_results$Dimension <- paste("Dimension==", plot_results$Dimension, sep = "")
print(knitr::kable(plot_results %>% group_by(beta_12, Dimension,Factor, Analysis) %>%  summarise(Average_ARI = mean(ARI), SE_ARI = sd(ARI))), format = "markdown")
plot_results <- plot_results %>% group_by(beta_12, Factor, Dimension, Analysis) %>%  summarise(Average_ARI = mean(ARI), SE_ARI = sd(ARI))

plot_results$Interaction <- ifelse(plot_results$beta_12=="beta[12]==11", "Interaction==1","Interaction==2")
p_scPCA <- ggplot(plot_results)+
  geom_bar(aes(x = Factor, fill = Analysis, y = Average_ARI+0.5), stat="identity", position ="dodge")+
  facet_nested( ~ Interaction + factor(Dimension, levels = c("Dimension==650","Dimension==850","Dimension==1250")), labeller = label_parsed)+
  labs(x = "", y="Average ARI")+
  scale_y_continuous(breaks = c(0.5,1,1.5), limits = c(0,1.5), labels=c("0","0.5","1"))+
  theme_bw()+
  theme(
    panel.grid = element_blank(),
    strip.background = element_rect(fill = "lightblue", color = "black"),
    strip.text = element_text(color = "black", face = "bold", size = 14),
    text = element_text(size = 14),  # Adjust text size
    axis.title = element_text(size = 16),  # Adjust axis title size
    axis.text = element_text(size = 12),   # Adjust axis text size
    legend.position = "bottom"
  )+
  scale_color_aaas()
print(p_scPCA)
# ggsave("../inst/SavedFigures/sim_scPCA.pdf", plot = p_scPCA, width = 12, height = 3.5, units = "in")

```



## 4. Simulation for robustness of $\eta$ tuning algorithm.

### eta tuning robustness

```{r simulation eta_tuning algorithm robustness, eval=FALSE}
beta_12_candidates <- c(10, 11, 12)
n_candidates <- c(100, 200, 300)
p_candidates <- c(10)
eta_range <- seq(0.1, 5, 0.05)
results <- setNames(data.frame(matrix(ncol = 7, nrow = 0)), 
                    c("eta", "eta_true", "nuisance_ARI", "silhouette",
                      "beta12", "SampleGroupSize", "FeatureGroupSize"))

eta_opt_res <- setNames(data.frame(matrix(ncol = 4, nrow = 0)), 
                    c("eta_opt", "beta12",  "SampleGroupSize", "FeatureGroupSize"))
nuisance_ARI_repe_list <- list()
silhouette_repe_list <- list()
eta_opt_repe_list <- list()
for (beta_12 in beta_12_candidates) {
    for (n in n_candidates) {
      for(p in p_candidates){
         res <- sim_eta_tuning(gnt = n, gnc = n, p = p, q = p, t = p,
                               sigma_1t = 1, sigma_2t = 1, sigma_3t = 1,
                               sigma_1c = 1, sigma_2c = 1, sigma_3c = 1, 
                               Sigma_t = toeplitz(0.5^(0:((p+p+p)-1))), # change 0.3 to 0.5 for the other plot
                               Sigma_c = NULL,
                               beta_11 = 7, beta_12 = beta_12, beta_21 = 3, beta_22 = 6,
                               gamma_11 = -3, gamma_12 = 3, gamma_21 = -3, gamma_22 = 3,
                               eta_range = eta_range, repetition = 50)
         res_df <- res$res_df
         res_df$beta_12 <- beta_12
         res_df$SampleGroupSize <- n
         res_df$FeatureGroupSize <- p
         results <- rbind(results, res_df)
         
         eta_opt_res_df <- data.frame(eta_opt=res$eta_opt,
                                      beta_12=beta_12,
                                      SampleGroupSize=n,
                                      FeatureGroupSize=p)
         eta_opt_res <- rbind(eta_opt_res, eta_opt_res_df)
         
         nuisance_ARI_repe_list <- append(nuisance_ARI_repe_list, list(res$nuisance_ARI_repe))
         silhouette_repe_list <- append(silhouette_repe_list, list(res$silhouette_repe))
         eta_opt_repe_list <- append(eta_opt_repe_list, list(res$eta_opt_repe))
         names(nuisance_ARI_repe_list)[length(nuisance_ARI_repe_list)] <- names(silhouette_repe_list)[length(silhouette_repe_list)]  <- names(eta_opt_repe_list)[length(eta_opt_repe_list)] <- paste("beta_12=", beta_12, ",n=", n, sep = "")
         
      }
    }
}
eta_opt_res$beta_12 <- paste("beta[12]==", eta_opt_res$beta_12, sep = "")
eta_opt_res$SampleGroupSize <- paste("n==", eta_opt_res$SampleGroupSize, sep = "")
# save(results, eta_opt_res, nuisance_ARI_repe_list, silhouette_repe_list, eta_opt_repe_list, file = "../inst/SavedData/sim_etaTuning_Toep03.RData")
# save(results, eta_opt_res, nuisance_ARI_repe_list, silhouette_repe_list, eta_opt_repe_list, file = "../inst/SavedData/sim_etaTuning_Toep05.RData")
```

#### Fig S3

```{r simulation eta_tuning algorithm robustness visualization}
load("../inst/SavedData/sim_etaTuning_Toep03.RData") # for averaged results
# load("../inst/SavedData/sim_etaTuning_Toep05.RData") # for averaged results

plot_df <- pivot_longer(results[results$eta %in% seq(0.1,5,0.25),], 3:4, names_to = "Metric", values_to = "Values")
plot_df$Interaction <- plot_df$beta_12
plot_df$Interaction[plot_df$beta_12 == 10] <- "Interaction==0"
plot_df$Interaction[plot_df$beta_12 == 11] <- "Interaction==1"
plot_df$Interaction[plot_df$beta_12 == 12] <- "Interaction==2"
plot_df$beta_12 <- paste("beta[12]==", plot_df$beta_12, sep = "")
plot_df$SampleGroupSize <- paste("n==", plot_df$SampleGroupSize, sep = "")
plot_df$eta_true <- factor(plot_df$eta_true, levels = c("BadEta","GoodEta"), labels = c( "Outside range","In range"))
plot_df$Metric <- factor(plot_df$Metric, levels = c("nuisance_ARI","silhouette"), labels = c("ARI(nuisance)", "Silhouette score"))
eta_opt_res$Interaction <- rep(c("Interaction==0","Interaction==1","Interaction==2"), each=3)
p_eta <- ggplot(data = plot_df)+
    geom_point(aes(x = eta, y = Values, shape = Metric, color = eta_true), size = 2)+
    geom_vline(data = eta_opt_res, aes(xintercept = eta_opt), linetype = "dashed")+
    facet_grid(cols = vars(Interaction), rows =vars(SampleGroupSize), labeller = label_parsed)+
    theme_bw()+
    scale_shape_manual(values=c(5,16))+
    theme(
      panel.grid = element_blank(),
      strip.background = element_rect(fill = "lightblue", color = "black"),
      strip.text = element_text(color = "black", face = "bold", size = 14),
      text = element_text(size = 14),  # Adjust text size
      axis.title = element_text(size = 16),  # Adjust axis title size
      axis.text = element_text(size = 12),   # Adjust axis text size
      legend.position = "bottom")+
    labs(x = expression(eta), y = "", color = "", shape = "")+
    scale_color_aaas()

print(p_eta)
# ggsave("../inst/SavedFigures/sim_etaTuning_Toep03.pdf", plot = p_eta, width = 9, height = 7, units = "in")
# ggsave("../inst/SavedFigures/sim_etaTuning_Toep05.pdf", plot = p_eta, width = 9, height = 7, units = "in")
```

### cPCA robustness

```{r simulation for cPCA robustness, eval = FALSE}
beta_12_candidates <- c(11, 12)
n_candidates <- c(100,200,300)
p_candidates <- c(10)
eta_range <- seq(0.1, 5, 0.05)
results <- setNames(data.frame(matrix(ncol = 8, nrow = 0)), 
                    c("ARI_ctst_discovery", "ARI_ctst_nuisance",
                      "ARI_trt_discovery", "ARI_trt_nuisance",
                       "eta",  "beta12", "SampleGroupSize", "FeatureGroupSize"))

for (beta_12 in beta_12_candidates) {
    for (n in n_candidates) {
      for(p in p_candidates){
         res <- sim_cPCA (gnt = n, gnc = n, p = p, q = p, t = p,
                          sigma_1t = 1, sigma_2t = 1, sigma_3t = 1, 
                          sigma_1c = 1, sigma_2c = 1, sigma_3c = 1, 
                          Sigma_t = toeplitz(0.5^(0:((p+p+p)-1))), # change 0.3 to 0.5 for the other plot
                          Sigma_c = NULL,
                          beta_11 = 7, beta_12 = beta_12, beta_21 = 3, beta_22 = 6,
                          gamma_11 = -3, gamma_12 = 3, gamma_21 = -3, gamma_22 = 3,
                          eta = eta_range, repetition = 50, 
                          save_plot = FALSE)
         res$beta_12 <- beta_12
         res$SampleGroupSize <- n
         res$FeatureGroupSize <- p
         results <- rbind(results, res)
      }
    }
}
# save(results, file = "../inst/SavedData/sim_cPCA_Toep03.RData")
# save(results, file = "../inst/SavedData/sim_cPCA_Toep05.RData")

```

#### Fig S4a and Fig S4b

```{r simulation for cPCA robustness visualization }
load("../inst/SavedData/sim_cPCA_Toep03.RData")
# load("../inst/SavedData/sim_cPCA_Toep05.RData")
plot_results <- pivot_longer(results, 1:4, names_to = "Type", values_to = "ARI")
plot_results$Analysis <- sapply(plot_results$Type, function(x){strsplit(x,"_")[[1]][2]})
plot_results$Factor <- sapply(plot_results$Type, function(x){strsplit(x,"_")[[1]][3]})
plot_results$Analysis <- ifelse(plot_results$Analysis=="ctst","Contrastive","Treatment")
plot_results$Factor <- ifelse(plot_results$Factor=="discovery","Interesting","Nuisance")
plot_results$eta <- paste("eta==", plot_results$eta, sep = "")
plot_results$beta_12_num <- plot_results$beta_12
plot_results$beta_12 <- paste("beta[12]==", plot_results$beta_12, sep = "")
plot_results$SampleGroupSize <- paste("n==", plot_results$SampleGroupSize, sep = "")
print(knitr::kable(plot_results %>% group_by(beta_12, Factor, Analysis) %>%  summarise(Average_ARI = mean(ARI), SE_ARI = sd(ARI))), format = "markdown")
plot_results <- plot_results %>% group_by(beta_12, Factor, SampleGroupSize, Analysis) %>%  summarise(Average_ARI = mean(ARI), SE_ARI = sd(ARI))
plot_results$Interaction <- ifelse(plot_results$beta_12=="beta[12]==11", "Interaction==1","Interaction==2")


p_cPCA <- ggplot(plot_results)+
  geom_bar(aes(x = Factor, fill = Analysis, y = Average_ARI+0.5), stat="identity", position ="dodge")+
  facet_nested( ~ Interaction + SampleGroupSize, labeller = label_parsed)+
  labs(x = "", y="Average ARI")+
  scale_y_continuous(breaks = c(0.5,1,1.5), limits = c(0,1.5), labels=c("0","0.5","1"))+
  theme_bw()+
  theme(
    panel.grid = element_blank(),
    strip.background = element_rect(fill = "lightblue", color = "black"),
    strip.text = element_text(color = "black", face = "bold", size = 14),
    text = element_text(size = 14),  # Adjust text size
    axis.title = element_text(size = 16),  # Adjust axis title size
    axis.text = element_text(size = 12),   # Adjust axis text size
    # axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom"
  )+
  scale_color_aaas()
print(p_cPCA)

# ggsave("../inst/SavedFigures/sim_cPCA_Toep03.pdf", plot = p_cPCA, width = 12, height = 3.5, units = "in")
# ggsave("../inst/SavedFigures/sim_cPCA_Toep05.pdf", plot = p_cPCA, width = 12, height = 3.5, units = "in")
```

## 5. Simulation for 3CA

```{r simulation for 3CA, eval=FALSE}
n_candidates <- c(1000, 2000, 3000)
AR_candidates <- c(0.5, 0.7, 0.9)
results <- setNames(data.frame(matrix(ncol = 6, nrow = 0)), 
                    c("est_trt_cca", "est_ctst_cca", "est_ctst_pca", "eta_est", 
                      "SampleSize", "AR"))
for (n in n_candidates) {
  for (AR in AR_candidates){
    res <- sim_3CA(nt = n, nc = n, p = 40, q = 40, s = 10, AR = AR,
                   lambda_t = c(6, 4, 2, 0), lambda_c = c(2, 0.2), eta = NULL,
                   lm_sigma = 1, lm_beta = 1.5, repetition = 50)
    rownames(res) <- NULL
    res$SampleSize <- n
    res$AR <- AR
    results <- rbind(results, res)
  }
}
# save(results, file = "../inst/SavedData/sim_3CA.RData")
```

#### Fig 4

```{r simulation for 3CA visualization}
load("../inst/SavedData/sim_3CA.RData")
plot_results <- pivot_longer(results, 1:3, names_to = "Type", values_to = "Estimation")
plot_results$Analysis <- sub(".*?_", "", plot_results$Type)
plot_results$SampleSize <- paste("n=", plot_results$SampleSize, sep = "")
plot_results$AR <- paste("AR=", plot_results$AR, sep = "")
plot_results$Analysis <- factor(plot_results$Analysis, labels = c("ContrastiveCCA", "ContrastivePCA", "TreatmentCCA"))
## boxplot
p_3CA <- ggplot(data = plot_results)+
            geom_boxplot(aes(x = factor(Analysis, levels=c("ContrastiveCCA", "ContrastivePCA", "TreatmentCCA"), labels=c("3CA", "cPCA", "trtCCA")), y = abs(Estimation), fill = Analysis), show.legend = FALSE)+
            facet_grid(cols = vars(SampleSize), rows = vars(AR))+
            geom_hline(yintercept = 1.5, linetype = "dashed", color="red")+
            scale_y_continuous(breaks = c( 0, 1.5))+
            theme_bw()+
            theme(
              panel.grid = element_blank(),
              strip.background = element_rect(fill = "lightblue", color = "black"),
              strip.text = element_text(color = "black", face = "bold", size = 14),
              text = element_text(size = 14),  # Adjust text size
              axis.title = element_text(size = 16),  # Adjust axis title size
              axis.text = element_text(size = 12),   # Adjust axis text size
              # axis.text.x = element_text(angle = 45, hjust = 1)
            )+
            scale_fill_d3()+
            labs(y = "Estimation of the coefficient in (3.1)",x="Analysis")
print(p_3CA)
# ggsave("../inst/SavedFigures/sim_3CA.pdf", plot = p_3CA, width = 10, height = 10, units = "in")

```


## 6. Simulation for s3CA

```{r simulation for s3CA, eval=FALSE}
n_candidates <- c(3000)
AR_candidates <- c(0.5, 0.7, 0.9)
p_candidates <- c(300, 350, 400)
s_candidates <- c(5,10)
results <- setNames(data.frame(matrix(ncol = 7, nrow = 0)), 
                    c("est_trt_cca", "est_ctst_cca", "est_ctst_pca", "eta_est",
                      "Dimension", "AR","Sparsity"))
for (n in n_candidates) {
  for (AR in AR_candidates){
    for (p in p_candidates) {
      for (s in s_candidates) {
        res <- sim_s3CA(nt = n, nc = n, p = p, q = p, s = s, 
                        lambda_t = c(6, 4, 2, 0), lambda_c = c(2, 0.2), eta = NULL,
                        AR = AR, lm_sigma = 1, lm_beta = 1.5, repetition = 50)
        rownames(res) <- NULL
        res$Dimension <- p
        res$AR <- AR
        res$Sparsity <- s
        results <- rbind(results, res)
      }
    }
  }
}
# save(results, file = "../inst/SavedData/sim_s3CA.RData")
```

#### Fig 5 and Fig S5

```{r simulation for s3CA visualization}
load("../inst/SavedData/sim_s3CA.RData")
plot_results <- pivot_longer(results, 1:3, names_to = "Type", values_to = "Estimation")
plot_results$Analysis <- sub(".*?_", "", plot_results$Type)
plot_results$Dimension <- paste("p=", plot_results$Dimension, sep = "")
plot_results$AR <- paste("AR=", plot_results$AR, sep = "")
plot_results$Analysis <- factor(plot_results$Analysis, labels = c("ContrastiveCCA", "ContrastivePCA", "TreatmentCCA"))
plot_results$Sparsity <- paste("# of non-zero elements =", plot_results$Sparsity)

p_s3CA <- ggplot(data = plot_results[plot_results$Sparsity == "# of non-zero elements = 10",])+
      geom_boxplot(aes(x = factor(Analysis, levels=c("ContrastiveCCA", "ContrastivePCA", "TreatmentCCA"), labels=c("s3CA", "scPCA", "trtsCCA")), y = abs(Estimation), fill = Analysis), show.legend = FALSE)+
      facet_nested(AR~Sparsity+Dimension)+
      geom_hline(yintercept = 1.5, linetype = "dashed", color="red")+
      scale_y_continuous(breaks = c( 0, 1.5))+
      theme_bw()+
      theme(
        panel.grid = element_blank(),
        strip.background = element_rect(fill = "lightblue", color = "black"),
        strip.text = element_text(color = "black", face = "bold", size = 14),
        text = element_text(size = 14),  # Adjust text size
        axis.title = element_text(size = 16),  # Adjust axis title size
        axis.text = element_text(size = 12),   # Adjust axis text size
      )+
      scale_fill_d3()+
      labs(y = "Estimation of the coefficient in (3.1)",x="Analysis")
print(p_s3CA)
# ggsave("../inst/SavedFigures/sim_s3CA_s10.pdf", plot = p_s3CA, width = 10, height = 10, units = "in")
# ggsave("../inst/SavedFigures/sim_s3CA_s5.pdf", plot = p_s3CA, width = 10, height = 10, units = "in")
```


# Real data applications

## 1. Real data application of scPCA on Barley data.

```{r barley data scPCA,message=FALSE,warning=FALSE}
data("barley")
X <- log(barley$data + 1)

# pre-screening of less variable (var on log scale <= 1) genes across all samples
gene_vars <- apply(X, 2, var)
X_sub <- X[, gene_vars > 1]
covariates_sub <- barley$covariates

# focus on samples with genotype in (Mla6, Mla13) and time in (0h, 8h, 24h ,32h)
sel <- covariates_sub$Genotype != "Mla1" & covariates_sub$Time_bi != "Middle"
X_sel <- X_sub[sel,]
covariates_sel <- covariates_sub[sel, ]
rownames(X_sel) <- paste(covariates_sel$Isolate, covariates_sel$Genotype, covariates_sel$Time_bi)

# fit linear mixed effect model and select genes
lmer_res_ori <- apply(X_sel, 2, function(x){anova(lmer(x ~ Genotype*Isolate*Time + (1|Rep) + (1|Rep:Isolate) + (1|Rep:Isolate:Genotype), data = covariates_sel))})
lmer_pval_ori <- do.call(rbind, lapply(lmer_res_ori, function(x){round(x[ , "Pr(>F)"], 4)}))
colnames(lmer_pval_ori) <- c("Genotype","Isolate","Time","Genotype:Isolate","Genotype:Time","Isolate:Time","ThreeWay")

# direct selection based on different significance level
cPC_target_genes <- rownames(lmer_pval_ori)[apply(lmer_pval_ori, 1, function(x){x["Isolate"] < 0.05 & x["Isolate:Time"] < 0.05 & x["Genotype"] > 0.05 & x["Genotype:Time"] > 0.05 & x["Genotype:Isolate"] > 0.05})]
trtPC_target_genes <- rownames(lmer_pval_ori)[apply(lmer_pval_ori, 1, function(x){x["Genotype"] < 0.001 & x["Genotype:Time"] > 0.4 &  x["Genotype:Isolate"] > 0.4  & x["Isolate:Time"] > 0.4})]

genes_sel <- c(cPC_target_genes, trtPC_target_genes)

# specify data for scPCA use
trt <- covariates_sel[,"Time_bi"] == "Late"
Xt <- scale(X_sel[trt, genes_sel], center = TRUE, scale = TRUE)
Xc <- scale(X_sel[!trt, genes_sel], center = TRUE, scale = TRUE)

covariates_t <-  covariates_sel[trt,]
covariates_c <- covariates_sel[!trt,]
rownames(Xc) <- paste(covariates_c$Genotype, covariates_c$Isolate, covariates_c$Time_bi)
rownames(Xt) <- paste(covariates_t$Genotype, covariates_t$Isolate, covariates_t$Time_bi)

# perform scPCA
set.seed(111)
scPCA_res <- cPCA(Xt = Xt, Xc = Xc, eta = 1, sparse_ctst = 0.3, sparse_trt = 0.3, sparse_ctrl = 0.3)

# generate score plot
PCt <- scPCA_res$PCt
PCc <- scPCA_res$PCc
cPC <- scPCA_res$cPC
Ut <- scPCA_res$Ut
Uc <- scPCA_res$Uc
cU <- scPCA_res$cU

plot_data_t <- data.frame(cPC1 = cPC[,1], cPC2 = cPC[,2],
                          PC1 = PCt[,1], PC2 = PCt[,2],
                          Genotype = covariates_t$Genotype,
                          Isolate = covariates_t$Isolate,
                          Time = covariates_t$Time,
                          Time_bi = factor(covariates_t$Time_bi, levels = c("Early","Late")))
plot_data_c <- data.frame(PC1 = PCc[,1], PC2 = PCc[,2], 
                          Genotype = covariates_c$Genotype,
                          Isolate = covariates_c$Isolate,
                          Time = covariates_c$Time,
                          Time_bi = factor(covariates_c$Time_bi, levels = c("Early","Late")))
ARI_data <- data.frame(ARI_genotype = paste("ARI(Genotype) = ", 
                  c(spec_clust(plot_data_t$PC1, group = plot_data_t$Genotype),
                    spec_clust(plot_data_t$cPC1, group = plot_data_t$Genotype),
                    spec_clust(plot_data_c$PC1, group = plot_data_c$Genotype)), sep = ""), ARI_fungus = paste("ARI(Fungus) = ", 
                  c(spec_clust(plot_data_t$PC1, group = plot_data_t$Isolate),
                    spec_clust(plot_data_t$cPC1, group = plot_data_t$Isolate),
                    spec_clust(plot_data_c$PC1, group = plot_data_c$Isolate)), sep = ""), row.names = c("Treatment", "Contrastive", "Control"))


cP <- ggplot(plot_data_t)+
  geom_point(aes(x = cPC1, y = cPC2, color = Isolate, shape = Genotype), size = 2)+
  theme_bw()+
  labs(title = "Contrastive", color = "Fungus")+
  geom_text(data=data.frame(a = 0, b = c(3,4), 
                            label = unlist(c(ARI_data["Contrastive",]))), 
            aes(x=a, y=b, label=label))+
  theme(panel.grid = element_blank(),
        text = element_text(size = 14),  # Adjust text size
        axis.title = element_text(size = 16),  # Adjust axis title size
        axis.text = element_text(size = 12),
        legend.position = "right")+
  scale_color_d3()
Pt <- ggplot(plot_data_t)+
  geom_point(aes(x=PC1, y=PC2, color= Isolate, shape = Genotype ), size = 2)+
  labs(title = "Late", color = "Fungus")+
  geom_text(data=data.frame(a = 0, b = c(3, 4), 
                            label = unlist(c(ARI_data["Treatment",]))), 
            aes(x=a, y=b, label=label))+
    theme_bw()+
  theme(panel.grid = element_blank(),
        text = element_text(size = 14),  # Adjust text size
        axis.title = element_text(size = 16),  # Adjust axis title size
        axis.text = element_text(size = 12),
        legend.position = "right")+
  scale_color_d3()
Pc <- ggplot(plot_data_c)+
  geom_point(aes(x=PC1, y=PC2, color= Isolate, shape = Genotype), size = 2)+
  labs(title = "Early", color = "Fungus")+
  theme_bw()+
  geom_text(data=data.frame(a = 0, b = c(3,4), 
                            label = unlist(c(ARI_data["Control",]))), 
            aes(x=a, y=b, label=label))+
  theme(panel.grid = element_blank(),
        text = element_text(size = 14),  # Adjust text size
        axis.title = element_text(size = 16),  # Adjust axis title size
        axis.text = element_text(size = 12),
        legend.position = "right")+
  scale_color_d3()

p_score <- ggarrange(Pc, Pt, cP,  nrow=1, ncol=3,  common.legend = TRUE, legend = "bottom")
print(p_score)
# ggsave("../inst/SavedFigures/Barley_score.pdf", plot = p_score, width = 12, height = 5)

# generate heatmap
X_plot <- X_sel[, genes_sel]
means <- aggregate(X_plot, by = list(Group = rownames(X_plot)), FUN = mean)
means$Isolate <- sapply(means$Group, function(x){strsplit(x, " ")[[1]][1]})
means$Genotype <- sapply(means$Group, function(x){strsplit(x, " ")[[1]][2]})
means$Time <- sapply(means$Group, function(x){paste(strsplit(x, " ")[[1]][3], collapse = " ")})
means <- means[order(means$Isolate, means$Genotype, means$Time),]
rownames(means) <- NULL

annotation_group <- HeatmapAnnotation(Genotype = means$Genotype, Fungus = means$Isolate)
annotation_loading <- HeatmapAnnotation(abs_ctstPC1_Loadings = abs(cU[,1]),
                                        abs_trtPC1_Loadings = abs(Ut[,1]), 
                                        which = "row", 
                                        annotation_name_rot = 90,
                                        annotation_name_gp= grid::gpar(fontsize = 10),
                                        annotation_name_side = "top",
                                        annotation_label = c("cPC1 loadings","Late PC1 loadigns"))
annotation_genetype <- HeatmapAnnotation(Type = rep(c("cPC1 target","Late PC1 target"),
                                                    c(length(cPC_target_genes), length(trtPC_target_genes))), 
                                         which = "row",
                                         annotation_name_gp= grid::gpar(fontsize = 10),
                                         annotation_name_side = "top")
# pdf("../inst/SavedFigures/Barley_heat.pdf", width = 10, height = 10)
draw(Heatmap(t(apply(t(means[,2:(ncol(means)-3)]),1, function(x)scale(x,scale=FALSE))),
              col = colorRampPalette(brewer.pal(9, "RdBu"))(100),
              name = "Log expression",
              bottom_annotation = annotation_group,
              left_annotation = annotation_loading,
              right_annotation = annotation_genetype,
              cluster_columns = FALSE,
              cluster_rows = FALSE,
              column_split = means$Time,
              heatmap_legend_param = list(legend_direction = "vertical")),
     heatmap_legend_side = "top",merge_legend = TRUE)
# dev.off()

# generate pvalue manhattan plot
ctst_pval_df <- data.frame(pvalues = (c(lmer_pval_ori[genes_sel, c("Genotype")], lmer_pval_ori[genes_sel, c("Isolate:Time")])),
                           Loadings = rep(cU[,1],2),
                           Type = rep(c("Genotype","Fungus:Time"), each = length(genes_sel)))
trt_pval_df <- data.frame(pvalues = (c(lmer_pval_ori[genes_sel, c("Genotype")], lmer_pval_ori[genes_sel, c("Isolate:Time")])),
                           Loadings = rep(Ut[,1],2),
                           Type = rep(c("Genotype","Fungus:Time"), each = length(genes_sel)))
p_man_trt_pval <- ggplot(data = trt_pval_df)+
  geom_point(aes(x = pvalues, y = Loadings, color = ifelse(Loadings!=0, "B", "A")),
             size=2,
             show.legend = FALSE)+
  labs(title = "", color = "", y = "Loadings",x = "Gene-wise p-values selected by Late PC1")+
  theme_bw()+
  facet_wrap(vars(Type))+
  theme(text = element_text(size = 14),  # Adjust text size
        axis.title = element_text(size = 16),  # Adjust axis title size
        axis.text = element_text(size = 12))+
  scale_color_aaas()

p_man_ctst_pval <- ggplot(data = ctst_pval_df)+
  geom_point(aes(y = Loadings, x = pvalues, color = ifelse(Loadings!=0, "B", "A")),
             size=2,
             show.legend = FALSE)+
  labs(title = "", color = "", y = "Loadings",x = "Gene-wise p-values selected by cPC1")+
  theme_bw()+
  facet_wrap(vars(Type))+
  theme(text = element_text(size = 14),  # Adjust text size
        axis.title = element_text(size = 16),  # Adjust axis title size
        axis.text = element_text(size = 12))+
  scale_color_aaas()
print(p_man_ctst_pval)
print(p_man_trt_pval)
# ggsave("../inst/SavedFigures/Barley_Ut1_pval.pdf", p_man_trt_pval, width = 10, height = 5)
# ggsave("../inst/SavedFigures/Barley_cU1_pval.pdf", p_man_ctst_pval, width = 10, height = 5)
```


## 2. Real data application of s3CA on COVID19 data.

```{r covid data s3CA}
data(covid)
covariates <- covid$covariates
mtb <- covid$mtb
protein <- covid$protein

# transformation
mtb_log <- log(mtb + 1)
protein_log <- log(protein + 1)

#### 1. Choose correlation or covariance ####
# Use correlation matrix or covariance matrix
cormat <- TRUE
# Use assigned eta and zta
eta_assign <- 1 # or NULL to use eta estimation
#### 2. Choose conditions ####
# Take Covid as conditions 
Xc <- scale(mtb_log[covariates$covid == "Non-Covid", ], scale = cormat)
Yc <- scale(protein_log[covariates$covid == "Non-Covid",], scale = cormat)
Xt <- scale(mtb_log[covariates$covid != "Non-Covid",], scale = cormat)
Yt <- scale(protein_log[covariates$covid != "Non-Covid",], scale = cormat)

p <- ncol(Xc)
q <- ncol(Yc)
nc <- nrow(Xc)
nt <- nrow(Xt)
Kmax <- min(p, q, nt-1)
covariates_c <- covariates[rownames(Xc),]
covariates_t <- covariates[rownames(Xt),]


#### 3. s3CA  ####

res_s3CA <- cCCA(Xc = Xc, Yc = Yc, Xt = Xt, Yt = Yt, eta  = eta_assign,
                    sparse_ctst = seq(0.2, 1, len=20), sparse_trt = seq(0.2, 1, len=40), sparse_ctrl = seq(0.2, 1, len=40))
CCA_ctst <- res_s3CA$CCA_ctst
CCA_ctrl <- res_s3CA$CCA_ctrl
CCA_trt <- res_s3CA$CCA_trt

K_single <- K_t <- K_c <- 1
cCCX <- Xt%*%as.matrix(CCA_ctst$u[,K_single])
cCCY <- Yt%*%as.matrix(CCA_ctst$v[,K_single])

df_score <- data.frame(cCCX = cCCX, cCCY = cCCY, covariates_t)

df_score_t <- data.frame(CCtX = Xt%*%as.matrix(CCA_trt$u[,K_t]), 
                         CCtY = Yt%*%as.matrix(CCA_trt$v[,K_t]), covariates_t)

df_score_c <- data.frame(CCcX = Xc%*%as.matrix(CCA_ctrl$u[,K_c]), 
                         CCcY = Yc%*%as.matrix(CCA_ctrl$v[,K_c]), covariates_c)


#### 4. Visualization ####
# 4.1. scree
p_scree <- ggplot(data = data.frame(Component = 1:Kmax, Variation = CCA_ctst$d/sum(CCA_ctst$d)))+
  geom_point(aes(x = Component, y = Variation))+
  theme_bw()+ 
  labs(y = "Proportion of explained variation")+
  theme(
        panel.grid = element_blank(),
        text = element_text(size = 14),  # Adjust text size
        axis.title = element_text(size = 16),  # Adjust axis title size
        axis.text = element_text(size = 12)
      )
print(p_scree)
# ggsave("../inst/SavedFigures/COVID_scree.pdf", plot = p_scree, width = 5, height = 4)


# 4.2. covariance discrepancy
K <- 30
Wc <- Xc%*%CCA_ctst$u[,1:K]
Zc <- Yc%*%CCA_ctst$v[,1:K]
Wt <- Xt%*%CCA_ctst$u[,1:K]
Zt <- Yt%*%CCA_ctst$v[,1:K]

cor_disc <- data.frame(Component = rep(1:K, 2),
                       Cov = c(diag(cov(Wc, Zc)), diag(cov(Wt, Zt))),
                       Type = rep(c("Control", "Treatment"), each = K))
p_disc <- ggplot(data = cor_disc) +
  geom_line(aes(x = Component, y = Cov, color = Type))+
  labs(y = "Cov(Xu, Yv)")+
  theme_bw()+
  theme(
        panel.grid = element_blank(),
        text = element_text(size = 14),  # Adjust text size
        axis.title = element_text(size = 16),  # Adjust axis title size
        axis.text = element_text(size = 12),
        legend.position = "bottom"
      )+
  scale_color_aaas()
# ggsave("../inst/SavedFigures/COVID_disc.pdf", plot = p_disc, width = 6, height = 5)
print(p_disc)


# 4.3. score scatter nuisance removal
nuisance <-  "icu"
ARI_removal <- c(spec_clust(Yc%*%CCA_ctrl$v[,1], group = df_score_c[,nuisance]),
                 spec_clust(Yt%*%CCA_trt$v[,1], group = df_score_t[,nuisance]),
                 spec_clust(Yt%*%CCA_ctst$v[,1], group = df_score[,nuisance]))
ARI_removal <- paste("ARI(ICU) = ", ARI_removal)
names(ARI_removal) <- c("Control","Treatment","Contrastive")

# 4.4. score scatter continuous interested regression
interested_y <- "Platelet_K.uL"
pval_sig <- c(summary(score_reg(x = data.frame(x = df_score[,"cCCY"]),
                                y = df_score[,interested_y]))$coefficients[2,"Pr(>|t|)"],
              summary(score_reg(x = data.frame(x = df_score_t[,"CCtY"]),
                                y = df_score_t[,interested_y]))$coefficients[2,"Pr(>|t|)"],
              summary(score_reg(data.frame(x = df_score_c[,"CCcY"]), 
                                y = df_score_c[,interested_y]))$coefficients[2,"Pr(>|t|)"])
pval_sig <- round(pval_sig, 4)
pval_sig <- paste("P-value = ", pval_sig, sep = "")
names(pval_sig) <- c("Contrastive","Treatment","Control")

p_reg <- ggplot(data = data.frame(df_score[,c("cCCY","icu",interested_y)]),
                aes_string(x = "cCCY",y = interested_y))+
  geom_point(aes_string(color = "icu" ))+ 
  geom_smooth(method = "lm", se = TRUE)+
  geom_text(data = data.frame(a=c(3,3),b=c(700, 600),
                              label=c(ARI_removal["Contrastive"], pval_sig["Contrastive"])), 
            aes(x = a, y = b, label = label))+
  theme_bw()+
  labs(title = "Contrastive", x = "Yv", color = "")+
  theme(panel.grid = element_blank(),
        text = element_text(size = 14),  # Adjust text size
        axis.title = element_text(size = 16),  # Adjust axis title size
        axis.text = element_text(size = 12),
        legend.position = "right")+
  scale_color_d3()
p_reg_t <- ggplot(data = data.frame(df_score_t[, c("CCtY", "icu",interested_y)]),
                aes_string(x = "CCtY",y = interested_y))+
  geom_point(aes_string(color = "icu" ))+  
  geom_smooth(method = "lm", se = TRUE)+
  geom_text(data = data.frame(a=c(-10,-10),b=c(700, 600),
                              label=c(ARI_removal["Treatment"], pval_sig["Treatment"])), 
            aes(x = a, y = b, label = label))+
  theme_bw()+
  labs(title = "COVID", x = "Yv", color = "")+
  theme(panel.grid = element_blank(),
        text = element_text(size = 14),  # Adjust text size
        axis.title = element_text(size = 16),  # Adjust axis title size
        axis.text = element_text(size = 12),
        legend.position = "right")+
  scale_color_d3()
p_reg_c <- ggplot(data = data.frame(df_score_c[, c("CCcY", "icu",interested_y)]),
                aes_string(x = "CCcY",y = interested_y))+
  geom_point(aes_string(color = "icu" ))+ 
  geom_smooth(method = "lm", se = TRUE)+
  geom_text(data = data.frame(a=c(-15,-15),b=c(313, 267),
                              label=c(ARI_removal["Control"], pval_sig["Control"])), 
            aes(x = a, y = b, label = label))+
  theme_bw()+
  labs(title = "Non COVID", x = "Yv", color = "")+
  theme(panel.grid = element_blank(),
        text = element_text(size = 14),  # Adjust text size
        axis.title = element_text(size = 16),  # Adjust axis title size
        axis.text = element_text(size = 12),
        legend.position = "right")+
  scale_color_d3()

p_score <- ggarrange(p_reg_t, p_reg_c, p_reg, common.legend = T, 
                     legend = "bottom", nrow=1, align = "hv")
print(p_score)
# ggsave("../inst/SavedFigures/COVID_score.pdf", plot = p_score, width = 12, height = 6)
           

# 4.5 loading plot
p_loading <- ggplot(data = data.frame(index = 1:ncol(Yt),
                                      Loadings = sort(abs(CCA_ctst$v[,1]))))+
  geom_point(aes(x=index, y=Loadings))+
  theme_bw()+
  labs( x = "Proteins", y = "Absolute values of loadings")+
  theme(panel.grid = element_blank(),
        text = element_text(size = 14),  # Adjust text size
        axis.title = element_text(size = 16),  # Adjust axis title size
        axis.text = element_text(size = 12),
        legend.position = "right")+
  scale_color_d3()
print(p_loading)

# ggsave("../inst/SavedFigures/COVID_loadings.pdf", plot = p_loading, width = 5, height = 4)

```

